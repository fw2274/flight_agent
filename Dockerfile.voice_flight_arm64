# Complete Voice-to-Flight Search ARM64 Docker Image
# Includes: Rust voice-to-text MCP server + Python flight search

FROM arm64v8/ubuntu:22.04 AS builder

# Avoid prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8

# Install build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    pkg-config \
    libssl-dev \
    libasound2-dev \
    portaudio19-dev \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Build voice-to-text MCP server
WORKDIR /build/voice-to-text-mcp
COPY voice-to-text-mcp/Cargo.toml voice-to-text-mcp/Cargo.lock ./
COPY voice-to-text-mcp/src ./src
COPY voice-to-text-mcp/tests ./tests

# Build the Rust binary for ARM64
RUN cargo build --release

# Runtime image
FROM arm64v8/ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
WORKDIR /app

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    libasound2 \
    portaudio19-dev \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Copy voice-to-text binary
COPY --from=builder /build/voice-to-text-mcp/target/release/voice-to-text-mcp /app/voice-to-text-mcp

# Copy Whisper model (if exists)
COPY voice-to-text-mcp/models/*.bin /app/models/ 2>/dev/null || mkdir -p /app/models

# Copy Python application
COPY flight_search_tablet.py /app/
COPY voice_to_flight_integrated.py /app/
COPY requirements_termux.txt /app/requirements.txt
COPY .env /app/.env

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
    google-generativeai \
    requests \
    python-dotenv \
    pydantic

# Create model download script
RUN echo '#!/bin/bash' > /app/download_model.sh && \
    echo 'cd /app/models' >> /app/download_model.sh && \
    echo 'if [ ! -f "ggml-base.en.bin" ]; then' >> /app/download_model.sh && \
    echo '  echo "Downloading Whisper model..."' >> /app/download_model.sh && \
    echo '  curl -L -O https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin' >> /app/download_model.sh && \
    echo '  echo "Model downloaded successfully!"' >> /app/download_model.sh && \
    echo 'else' >> /app/download_model.sh && \
    echo '  echo "Model already exists."' >> /app/download_model.sh && \
    echo 'fi' >> /app/download_model.sh && \
    chmod +x /app/download_model.sh

# Create verification script
RUN echo '#!/bin/bash' > /app/verify_arm64.sh && \
    echo 'echo "========================================="' >> /app/verify_arm64.sh && \
    echo 'echo "ARM64 Voice-to-Flight Search Verification"' >> /app/verify_arm64.sh && \
    echo 'echo "========================================="' >> /app/verify_arm64.sh && \
    echo 'echo ""' >> /app/verify_arm64.sh && \
    echo 'echo "Architecture: $(uname -m)"' >> /app/verify_arm64.sh && \
    echo 'echo "Python: $(python3 --version)"' >> /app/verify_arm64.sh && \
    echo 'echo ""' >> /app/verify_arm64.sh && \
    echo 'echo "Voice-to-Text Binary:"' >> /app/verify_arm64.sh && \
    echo 'ls -lh /app/voice-to-text-mcp' >> /app/verify_arm64.sh && \
    echo 'echo ""' >> /app/verify_arm64.sh && \
    echo 'echo "Python Scripts:"' >> /app/verify_arm64.sh && \
    echo 'ls -lh /app/*.py' >> /app/verify_arm64.sh && \
    echo 'echo ""' >> /app/verify_arm64.sh && \
    echo 'echo "Whisper Models:"' >> /app/verify_arm64.sh && \
    echo 'ls -lh /app/models/' >> /app/verify_arm64.sh && \
    echo 'echo ""' >> /app/verify_arm64.sh && \
    echo 'echo "========================================="' >> /app/verify_arm64.sh && \
    chmod +x /app/verify_arm64.sh

CMD ["/bin/bash"]
